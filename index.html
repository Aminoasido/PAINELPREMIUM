<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KSML PDV Pro Mobile</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#064e3b">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* CSS NATIVO PARA PERFORMANCE DO SISTEMA */
        :root { --primary: #15803d; --primary-dark: #064e3b; --primary-light: #dcfce7; --bg-body: #cbd5e1; --surface: #ffffff; --text-main: #0f172a; --text-muted: #64748b; --danger: #dc2626; --success: #16a34a; --warning: #ca8a04; --border: #e2e8f0; --radius: 12px; --shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        #app-system { display: none; height: 100vh; flex-direction: column; background-color: var(--bg-body); color: var(--text-main); overflow: hidden; }
        
        /* ESTILOS PDV */
        .main-content { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 90px; display: none; }
        .main-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .screen-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        h2 { font-size: 1.4rem; font-weight: 700; color: var(--primary-dark); margin: 0; }
        .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--surface); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 0.5rem; z-index: 100; }
        .nav-btn { background: none; border: none; color: var(--text-muted); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 500; padding: 6px; border-radius: 12px; transition: all 0.2s; flex: 1; }
        .nav-btn.active { background-color: var(--primary-light); color: var(--primary-dark); font-weight: 700; }
        
        .card { background: var(--surface); padding: 1.2rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1rem; }
        .btn { padding: 12px; border-radius: var(--radius); border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; } .btn-success { background: var(--success); color: white; } .btn-danger { background: var(--danger); color: white; } .btn-secondary { background: var(--text-muted); color: white; }
        .btn-sm { padding: 8px 12px; font-size: 0.85rem; }
        input, select { padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); width: 100%; outline: none; background: #fff; }
        
        .cart-list { height: calc(100vh - 280px); overflow-y: auto; padding-bottom: 20px; }
        .cart-item, .list-item { background: var(--surface); padding: 10px; margin-bottom: 10px; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .checkout-bar { position: fixed; bottom: 70px; left: 0; width: 100%; background: var(--surface); padding: 15px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 90; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-danger { background: #fee2e2; color: #b91c1c; } .badge-success { background: #dcfce7; color: #15803d; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 2000; align-items: flex-end; }
        .modal-content { background: var(--surface); width: 100%; max-height: 90vh; border-radius: 24px 24px 0 0; padding: 25px; overflow-y: auto; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .camera-btn-inside { position: absolute; right: 5px; top: 5px; bottom: 5px; background: var(--primary-light); color: var(--primary-dark); border: none; width: 40px; border-radius: 8px; cursor: pointer; }
        #scanner-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; flex-direction: column; }
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 6000; }
        .toast { background: #1e293b; color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        @media (min-width: 769px) {
            #app-system { flex-direction: row; }
            .sidebar { position: relative; width: 260px; height: 100vh; flex-direction: column; justify-content: flex-start; padding: 1.5rem; background: var(--primary-dark); border: none; }
            .nav-btn { flex-direction: row; justify-content: flex-start; padding: 12px; margin-bottom: 5px; color: var(--primary-light); font-size: 1rem; }
            .nav-btn i { margin-right: 10px; }
            .checkout-bar { position: relative; bottom: auto; left: auto; margin-top: 20px; border-radius: 12px; border: none; box-shadow: var(--shadow); }
            .modal { align-items: center; } .modal-content { width: 500px; border-radius: 12px; }
        }
        @media print { body * { visibility: hidden; } #receipt-print-area, #receipt-print-area * { visibility: visible; } #receipt-print-area { position: absolute; left: 0; top: 0; width: 80mm; font-family: 'Courier New', monospace; } }
    </style>
</head>
<body class="bg-slate-900">

    <div id="lockScreen" class="fixed inset-0 bg-slate-900 z-[9999] flex flex-col items-center justify-center p-4 overflow-y-auto">
        <div class="bg-slate-800 p-6 rounded-2xl border border-green-600 shadow-2xl w-full max-w-lg mt-10">
            <div class="text-center mb-4">
                <i class="fa-solid fa-store text-4xl text-green-500 mb-2"></i>
                <h1 class="text-2xl font-black text-white uppercase tracking-wider">KSML PDV</h1>
                <p class="text-slate-400 text-xs">Sistema de Caixa para Pequenos Neg√≥cios</p>
            </div>

            <div class="bg-black rounded-lg p-3 mb-6 border border-slate-700">
                <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">Seu ID de Dispositivo:</label>
                <div class="flex gap-2">
                    <input id="myDeviceId" type="text" class="w-full bg-transparent text-green-400 font-mono text-center font-bold outline-none" readonly>
                    <button onclick="copyId()" class="text-slate-400 hover:text-white"><i class="fa-regular fa-copy"></i></button>
                </div>
            </div>

            <h3 class="text-white text-sm font-bold mb-3 uppercase border-b border-slate-700 pb-2">Escolha seu Plano</h3>
            <div class="grid grid-cols-1 gap-3 mb-6">
                <button onclick="buyPlan('Mensal', '49,99')" class="flex justify-between items-center bg-slate-700 hover:bg-green-800 p-3 rounded-lg border border-slate-600 transition-all group">
                    <div class="text-left">
                        <div class="text-white font-bold text-sm">PLANO MENSAL</div>
                        <div class="text-slate-400 text-[10px]">Acesso total por 30 dias</div>
                    </div>
                    <div class="text-green-400 font-black text-lg group-hover:text-white">R$ 49,99</div>
                </button>
                
                <button onclick="buyPlan('Trimestral', '119,99')" class="flex justify-between items-center bg-slate-700 hover:bg-green-800 p-3 rounded-lg border border-slate-600 transition-all group">
                    <div class="text-left">
                        <div class="text-white font-bold text-sm">TRIMESTRAL</div>
                        <div class="text-slate-400 text-[10px]">90 dias (Economize 20%)</div>
                    </div>
                    <div class="text-green-400 font-black text-lg group-hover:text-white">R$ 119,99</div>
                </button>

                <button onclick="buyPlan('Anual', '299,99')" class="relative flex justify-between items-center bg-green-900/50 hover:bg-green-700 p-3 rounded-lg border border-green-500 transition-all group">
                    <div class="absolute -top-2 -right-2 bg-yellow-500 text-black text-[10px] font-bold px-2 py-0.5 rounded-full shadow">MELHOR PRE√áO</div>
                    <div class="text-left">
                        <div class="text-white font-bold text-sm">PLANO ANUAL</div>
                        <div class="text-green-200 text-[10px]">Acesso por 365 dias</div>
                    </div>
                    <div class="text-white font-black text-lg">R$ 299,99</div>
                </button>
            </div>

            <div class="mb-4">
                <label class="block text-[10px] uppercase font-bold text-slate-500 mb-1">J√° tem a chave?</label>
                <textarea id="activationKey" class="w-full h-12 bg-black border border-slate-600 p-2 text-green-400 font-mono text-xs rounded outline-none focus:border-green-500" placeholder="Cole sua chave aqui..."></textarea>
            </div>

            <button onclick="validateLicense()" class="w-full bg-green-600 hover:bg-green-500 text-black font-black py-3 rounded uppercase transition-all mb-4">
                VALIDAR ACESSO
            </button>
            
            <button onclick="openTermsModal()" class="w-full text-slate-500 text-xs hover:text-white underline">
                Termos de Uso e Pol√≠tica de Dados
            </button>
            
            <p id="errorMsg" class="text-red-400 text-xs font-bold mt-3 hidden text-center"></p>
        </div>
    </div>

    <div id="termsModal" class="fixed inset-0 bg-black/90 z-[10000] hidden flex-col items-center justify-center p-4">
        <div class="bg-white text-slate-900 rounded-lg max-w-lg w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-lg">Termos de Uso</h3>
                <button onclick="closeTermsModal()" class="text-slate-500 text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto text-sm text-slate-700 space-y-3 leading-relaxed">
                <p><strong>1. OBJETO:</strong> O software KSML PDV √© uma ferramenta de gest√£o "Frente de Caixa" desenvolvida para pequenos neg√≥cios. O sistema opera localmente no navegador do dispositivo.</p>
                <p><strong>2. DADOS E BACKUP:</strong> O Usu√°rio reconhece que todos os dados (vendas, produtos, clientes) s√£o armazenados <strong>EXCLUSIVAMENTE NO DISPOSITIVO DO USU√ÅRIO</strong> (Local Storage). O desenvolvedor N√ÉO tem acesso a esses dados e N√ÉO se responsabiliza por perdas decorrentes de formata√ß√£o, limpeza de cache, roubo do aparelho ou falhas de hardware. A realiza√ß√£o de backups (bot√£o Exportar Dados) √© de inteira responsabilidade do Usu√°rio.</p>
                <p><strong>3. GARANTIA:</strong> O software √© fornecido "no estado em que se encontra" (AS IS), sem garantias de adequa√ß√£o a prop√≥sitos espec√≠ficos fora do escopo de PDV simples.</p>
                <p><strong>4. PAGAMENTO:</strong> A licen√ßa √© concedida mediante pagamento antecipado. Por se tratar de produto digital consum√≠vel (chave de ativa√ß√£o), <strong>n√£o haver√° reembolso</strong> ap√≥s a chave ser gerada e enviada.</p>
                <p><strong>5. SUPORTE:</strong> O suporte limita-se a garantir o funcionamento do c√≥digo. N√£o inclui treinamento operacional de funcion√°rios ou consultoria cont√°bil.</p>
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50 rounded-b-lg">
                <button onclick="closeTermsModal()" class="w-full bg-slate-900 text-white font-bold py-3 rounded">ENTENDI E CONCORDO</button>
            </div>
        </div>
    </div>

    <div id="operatorLogin" class="fixed inset-0 bg-green-900 z-[8000] hidden flex-col items-center justify-center p-6 text-center text-white">
        <div class="bg-white text-slate-900 p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <i class="fa-solid fa-user-circle text-5xl text-green-600 mb-4"></i>
            <h2 class="text-2xl font-bold mb-1">Quem √© voc√™?</h2>
            <p class="text-slate-500 text-sm mb-6">Identifique-se para abrir o caixa.</p>
            <input type="text" id="operatorInput" class="w-full border-2 border-slate-200 p-3 rounded-lg text-center text-lg mb-4 outline-none focus:border-green-500" placeholder="Seu Nome">
            <button onclick="doOperatorLogin()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg uppercase transition-all">ENTRAR</button>
        </div>
    </div>

    <div id="app-system">
        <div id="scanner-modal"><div style="padding:20px; color:white; display:flex; justify-content:space-between; width:100%; position:absolute; top:0; background:rgba(0,0,0,0.5); z-index:5001;"><h3>Lendo...</h3><button onclick="stopScanner()" style="background:none; border:none; color:white; font-size:1.5rem;"><i class="fas fa-times"></i></button></div><div id="reader" style="width:100%; height:100%;"></div></div>
        
        <div id="dashboard" class="main-content active">
            <div class="screen-header">
                <div><h2>Vis√£o Geral</h2><span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded font-bold" id="displayOperator">---</span></div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-secondary btn-sm" onclick="configureStore()"><i class="fas fa-cog"></i></button>
                    <button class="btn-danger btn-sm" onclick="doLogout()"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
                <div class="card" style="text-align:center;"><i class="fas fa-cash-register fa-2x" style="color:var(--primary); margin-bottom:10px;"></i><small style="display:block; color:var(--text-muted)">Hoje</small><h2 id="dashSales" style="color:var(--primary-dark)">R$ 0,00</h2></div>
                <div class="card" style="text-align:center; background:#fffbeb;"><i class="fas fa-exclamation-circle fa-2x" style="color:var(--warning); margin-bottom:10px;"></i><small style="display:block; color:var(--text-muted)">Fiado</small><h2 id="dashFiado" style="color:var(--warning)">R$ 0,00</h2></div>
            </div>
            <div class="card" style="margin-top:10px; background:#f0fdf4; border:1px solid #bbf7d0;">
                <small style="color:var(--primary-dark); font-weight:bold;"><i class="fas fa-clock"></i> Licen√ßa V√°lida At√©:</small>
                <div id="licenseExpiryDisplay" class="font-mono text-lg text-green-700">---</div>
            </div>
        </div>

        <div id="pdv" class="main-content">
            <h2>Caixa</h2>
            <div style="position:relative; display:flex; gap:10px; margin-bottom:1rem;">
                <input type="text" id="barcodeInput" placeholder="Buscar..." onkeypress="handleBarcode(event)">
                <button class="camera-btn-inside" onclick="startScanner('pdv')"><i class="fas fa-barcode"></i></button>
            </div>
            <div class="cart-list" id="cartListContainer"></div>
            <div class="checkout-bar">
                <div><small class="text-muted">Total</small><div style="font-size:1.5rem; font-weight:800; color:var(--primary-dark);" id="totalDisplay">R$ 0,00</div></div>
                <button class="btn btn-success" onclick="openPaymentModal()">PAGAR <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div id="fiados" class="main-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:1rem;"><h2>Clientes</h2><button class="btn btn-primary btn-sm" onclick="openCustomerModal()">+ Novo</button></div>
            <div class="card" style="padding:0; overflow:hidden;" id="customersList"></div>
        </div>

        <div id="estoque" class="main-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:1rem;"><h2>Estoque</h2><button class="btn btn-primary btn-sm" onclick="openProductModal()">+ Novo</button></div>
            <div style="margin-bottom:1rem;"><input type="text" placeholder="Filtrar..." onkeyup="renderStock(this.value)"></div>
            <div class="card" style="padding:0; overflow:hidden;" id="stockList"></div>
        </div>

        <div id="vendas" class="main-content">
            <h2>Vendas</h2>
            <div class="card" style="padding:0; overflow:hidden;" id="salesList"></div>
        </div>

        <div class="sidebar">
            <button class="nav-btn active" onclick="showScreen('dashboard')"><i class="fas fa-chart-pie"></i>Vis√£o</button>
            <button class="nav-btn" onclick="showScreen('pdv')"><i class="fas fa-shopping-cart"></i>Caixa</button>
            <button class="nav-btn" onclick="showScreen('fiados')"><i class="fas fa-users"></i>Clientes</button>
            <button class="nav-btn" onclick="showScreen('estoque')"><i class="fas fa-box"></i>Estoque</button>
            <button class="nav-btn" onclick="showScreen('vendas')"><i class="fas fa-history"></i>Vendas</button>
        </div>

        <div id="paymentModal" class="modal"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:20px;"><h3>Pagamento</h3><button onclick="closeModal('paymentModal')" style="border:none;background:none;font-size:1.2rem;"><i class="fas fa-times"></i></button></div><h1 id="modalTotal" style="text-align:center;color:var(--primary);margin-bottom:20px;">R$ 0,00</h1><label>Cliente</label><select id="clientSelect" style="margin-bottom:15px;"></select><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px;"><div><label>Modo</label><select id="payMethod" onchange="toggleFiado()"><option>Dinheiro</option><option>Cart√£o</option><option>Pix</option><option value="Fiado" style="color:red;font-weight:bold">Fiado</option></select></div><div><label>Recebido</label><input type="number" id="payReceived" oninput="calcChange()"></div></div><div style="text-align:center;margin-bottom:15px;">Troco: <b id="payChange">R$ 0,00</b></div><button class="btn btn-success" style="width:100%" onclick="processSale()">CONFIRMAR</button></div></div>
        <div id="walletModal" class="modal"><div class="modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:20px;"><h3 id="walletName">---</h3><button onclick="closeModal('walletModal')" style="border:none;background:none;"><i class="fas fa-times"></i></button></div><div style="text-align:center;padding:15px;background:#f8fafc;border-radius:10px;margin-bottom:15px;"><small>D√≠vida Total</small><div id="walletDebt" style="font-size:1.5rem;color:var(--danger);font-weight:800;">R$ 0,00</div></div><div style="background:#f0fdf4;padding:15px;border-radius:10px;margin-bottom:15px;"><label style="font-weight:bold;color:var(--primary-dark)">Pagar D√≠vida</label><div style="display:flex;gap:10px;margin-top:5px;"><input type="number" id="walletPayInput" placeholder="R$"><button class="btn btn-success" onclick="makePayment()"><i class="fas fa-check"></i></button></div></div><h4>Pend√™ncias</h4><div style="max-height:200px;overflow-y:auto;margin-bottom:15px;"><table style="width:100%;font-size:0.8rem;"><tbody id="walletHistoryBody"></tbody></table></div><button class="btn btn-secondary" style="width:100%" onclick="printClientStatement()"><i class="fas fa-print"></i> Imprimir Extrato</button></div></div>
        <div id="productModal" class="modal"><div class="modal-content"><h3>Produto</h3><input type="hidden" id="prodId"><div style="position:relative;margin-bottom:10px;"><input type="text" id="prodBarcode" placeholder="C√≥digo"><button class="camera-btn-inside" onclick="startScanner('cadastro')"><i class="fas fa-camera"></i></button></div><input type="text" id="prodName" placeholder="Nome" style="margin-bottom:10px;"><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;"><input type="number" id="prodPrice" placeholder="Pre√ßo"><input type="number" id="prodQty" placeholder="Qtd"></div><button class="btn btn-primary" style="width:100%" onclick="saveProduct()">Salvar</button><br><br><button class="btn btn-danger" style="width:100%" onclick="closeModal('productModal')">Cancelar</button></div></div>
        <div id="customerModal" class="modal"><div class="modal-content"><h3>Cliente</h3><input type="text" id="custName" placeholder="Nome" style="margin-bottom:10px;"><input type="text" id="custCpf" placeholder="CPF" style="margin-bottom:20px;"><button class="btn btn-primary" style="width:100%" onclick="saveCustomer()">Salvar</button><br><br><button class="btn btn-danger" style="width:100%" onclick="closeModal('customerModal')">Cancelar</button></div></div>
    </div>

    <div id="receipt-print-area"></div>
    <div id="toast-container"></div>

    <script>
        // --- CONFIGURA√á√ÉO DO VENDEDOR (VOC√ä) ---
        const SECRET_SALT = "KSML_PDV_SECURE_2026_AMZ";
        const MEU_WHATSAPP = "5599999999999"; // <--- COLOQUE SEU N√öMERO AQUI (Ex: 5511999998888)

        // --- SISTEMA DE VENDA (WHATSAPP) ---
        function buyPlan(planName, price) {
            const id = document.getElementById('myDeviceId').value;
            const msg = `Ol√°! Gostaria de liberar o *KSML PDV*.\n\nüÜî ID: *${id}*\nüìÖ Plano: *${planName}*\nüí∞ Valor: *R$ ${price}*\n\nAguardo a chave PIX e a chave de ativa√ß√£o!`;
            const url = `https://wa.me/${MEU_WHATSAPP}?text=${encodeURIComponent(msg)}`;
            window.open(url, '_blank');
        }

        function openTermsModal() { document.getElementById('termsModal').classList.remove('hidden'); document.getElementById('termsModal').classList.add('flex'); }
        function closeTermsModal() { document.getElementById('termsModal').classList.add('hidden'); document.getElementById('termsModal').classList.remove('flex'); }

        // --- CORE DO SISTEMA ---
        let deviceId = localStorage.getItem('ksml_device_id');
        if (!deviceId) { deviceId = "PDV-" + Math.floor(Math.random() * 1000000).toString(16).toUpperCase(); localStorage.setItem('ksml_device_id', deviceId); }
        document.getElementById('myDeviceId').value = deviceId;

        function checkLicense() {
            const savedKey = localStorage.getItem('ksml_license_key');
            if (savedKey && processKey(savedKey)) {
                document.getElementById('lockScreen').classList.add('hidden');
                checkOperatorLogin();
            } else {
                document.getElementById('lockScreen').classList.remove('hidden');
            }
        }

        function validateLicense() {
            const key = document.getElementById('activationKey').value.trim();
            if (processKey(key)) {
                localStorage.setItem('ksml_license_key', key);
                alert("SISTEMA ATIVADO! OBRIGADO.");
                location.reload();
            } else {
                document.getElementById('errorMsg').innerText = "Chave Inv√°lida ou Expirada!";
                document.getElementById('errorMsg').classList.remove('hidden');
            }
        }

        function processKey(key) {
            try {
                const step1 = atob(key); const step2 = step1.split('').reverse().join(''); const rawString = atob(step2); const parts = rawString.split('|');
                if (parts.length !== 3) return false;
                if (parts[2] !== SECRET_SALT) return false;
                if (parts[0] !== deviceId) return false;
                const expiry = new Date(parts[1]); const today = new Date(); today.setHours(0,0,0,0); expiry.setHours(0,0,0,0);
                if (expiry < today) return false;
                document.getElementById('licenseExpiryDisplay').innerText = parts[1].split('-').reverse().join('/');
                return true;
            } catch (e) { return false; }
        }
        function copyId() { document.getElementById("myDeviceId").select(); document.execCommand("copy"); alert("ID Copiado"); }

        // --- LOGIN OPERADOR ---
        let currentOperator = localStorage.getItem('ksml_operator');
        function checkOperatorLogin() {
            if(currentOperator) {
                document.getElementById('operatorLogin').classList.remove('flex'); document.getElementById('operatorLogin').classList.add('hidden');
                document.getElementById('app-system').style.display = 'flex'; document.getElementById('displayOperator').innerText = currentOperator;
                initApp();
            } else {
                document.getElementById('operatorLogin').classList.remove('hidden'); document.getElementById('operatorLogin').classList.add('flex');
            }
        }
        function doOperatorLogin() { const name = document.getElementById('operatorInput').value; if(name) { currentOperator = name; localStorage.setItem('ksml_operator', name); checkOperatorLogin(); } }
        function doLogout() { if(confirm("Trocar de turno?")) { currentOperator = null; localStorage.removeItem('ksml_operator'); location.reload(); } }

        // --- APP LOGIC ---
        let products=[], customers=[], sales=[], cart=[], currentClientId=null;
        function initApp() {
            if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
            products = JSON.parse(localStorage.getItem('ksml_products')) || []; customers = JSON.parse(localStorage.getItem('ksml_customers')) || []; sales = JSON.parse(localStorage.getItem('ksml_sales')) || [];
            if(products.length===0) { products=[{id:1,name:'Prod Teste',barcode:'123',price:10,qty:100}]; customers=[{id:1,name:'Balcao'}]; saveData(); }
            updateDash(); renderStock();
        }

        // Functions (Minified logic)
        function saveData() { localStorage.setItem('ksml_products',JSON.stringify(products)); localStorage.setItem('ksml_customers',JSON.stringify(customers)); localStorage.setItem('ksml_sales',JSON.stringify(sales)); updateDash(); }
        function updateDash() { const today = new Date().toISOString().split('T')[0]; const sToday = sales.filter(s=>s.date.startsWith(today) && s.isPaid).reduce((a,b)=>a+b.total,0); const debit = sales.filter(s=>!s.isPaid).reduce((a,b)=>a+(b.total-(b.paidAmount||0)),0); document.getElementById('dashSales').innerText=`R$ ${sToday.toFixed(2)}`; document.getElementById('dashFiado').innerText=`R$ ${debit.toFixed(2)}`; }
        function handleBarcode(e) { if(e.key==='Enter') { const c=e.target.value; const p=products.find(x=>x.barcode==c||x.name.toLowerCase().includes(c.toLowerCase())); if(p){addToCart(p.id);e.target.value='';}else{showToast('N√£o achou','error');} } }
        function addToCart(id) { const p=products.find(x=>x.id==id); const i=cart.find(x=>x.id==id); if(i)i.qty++; else cart.push({...p,qty:1}); renderCart(); }
        function renderCart() { const div=document.getElementById('cartListContainer'); div.innerHTML=''; let t=0; cart.forEach((i,idx)=>{ t+=i.price*i.qty; div.innerHTML+=`<div class="cart-item"><div><b>${i.name}</b><br><small>${i.qty} x ${i.price}</small></div><div>R$ ${(i.price*i.qty).toFixed(2)} <i class="fas fa-trash text-red-500 ml-2" onclick="cart.splice(${idx},1);renderCart()"></i></div></div>`; }); document.getElementById('totalDisplay').innerText=`R$ ${t.toFixed(2)}`; document.getElementById('modalTotal').innerText=`R$ ${t.toFixed(2)}`; }
        function openPaymentModal() { if(cart.length==0)return showToast('Vazio','error'); const s=document.getElementById('clientSelect'); s.innerHTML='<option value="">Balc√£o</option>'; customers.forEach(c=>s.innerHTML+=`<option value="${c.id}">${c.name}</option>`); document.getElementById('paymentModal').style.display='flex'; }
        function toggleFiado() { const f=document.getElementById('payMethod').value==='Fiado'; document.getElementById('payReceived').disabled=f; if(f)document.getElementById('payReceived').value=''; }
        function calcChange() { const t=parseFloat(document.getElementById('modalTotal').innerText.replace('R$ ','')); const r=parseFloat(document.getElementById('payReceived').value); if(r)document.getElementById('payChange').innerText=`R$ ${(r-t).toFixed(2)}`; }
        function processSale() { const m=document.getElementById('payMethod').value; const cid=document.getElementById('clientSelect').value; const t=cart.reduce((a,b)=>a+b.price*b.qty,0); if(m==='Fiado' && !cid) return showToast('Selecione Cliente','error'); const sale = { id:Date.now(), date:new Date().toISOString(), clientId:cid, clientName:cid?customers.find(c=>c.id==cid).name:'Balc√£o', total:t, method:m, operator:currentOperator, isPaid:m!=='Fiado', paidAmount:m!=='Fiado'?t:0, items:[...cart] }; cart.forEach(i=>{ const p=products.find(x=>x.id==i.id); if(p)p.qty-=i.qty; }); sales.unshift(sale); saveData(); cart=[]; renderCart(); renderStock(); closeModal('paymentModal'); if(m!=='Fiado') printReceipt(sale); showToast('Venda OK'); }
        function getStoreName() { return localStorage.getItem('ksml_store_name') || 'KSML PDV'; }
        function configureStore() { const n=prompt('Nome da Loja', getStoreName()); if(n)localStorage.setItem('ksml_store_name',n); }
        function printReceipt(s) { let h=''; s.items.forEach(i=>h+=`<div>${i.qty}x ${i.name} - ${(i.price*i.qty).toFixed(2)}</div>`); document.getElementById('receipt-print-area').innerHTML=`<div class="receipt-header"><h2>${getStoreName()}</h2><small>Venda #${s.id.toString().slice(-4)}</small><br><small>Atend: ${s.operator}</small></div><div class="receipt-body"><div>Data: ${new Date(s.date).toLocaleString()}</div><div style="border-bottom:1px dashed #000; padding:5px 0; margin:5px 0;">${h}</div></div><div class="receipt-footer"><div style="font-weight:bold">Total: ${s.total.toFixed(2)}</div></div>`; window.print(); }
        function showScreen(id) { document.querySelectorAll('.main-content').forEach(d=>d.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.getElementById(id).classList.add('active'); if(id=='estoque')renderStock(); if(id=='fiados')renderCustomers(); if(id=='vendas')renderSales(); }
        function renderStock(f='') { const d=document.getElementById('stockList'); d.innerHTML=''; products.filter(p=>p.name.includes(f)).forEach(p=>d.innerHTML+=`<div class="list-item"><div><b>${p.name}</b><br><small>${p.barcode}</small></div><div>R$ ${p.price}<br><span class="badge ${p.qty<5?'badge-danger':'badge-success'}">${p.qty}</span></div></div>`); }
        function renderCustomers() { const d=document.getElementById('customersList'); d.innerHTML=''; customers.forEach(c=>{ const db=sales.filter(s=>s.clientId==c.id && !s.isPaid).reduce((a,b)=>a+(b.total-b.paidAmount),0); d.innerHTML+=`<div class="list-item" onclick="openWallet(${c.id})"><div><b>${c.name}</b></div><div style="color:${db>0?'red':'green'}">R$ ${db.toFixed(2)}</div></div>`; }); }
        function renderSales() { const d=document.getElementById('salesList'); d.innerHTML=''; sales.forEach(s=>d.innerHTML+=`<div class="list-item"><div>#${s.id.toString().slice(-4)}<br><small>${new Date(s.date).toLocaleString()}</small></div><div>R$ ${s.total}<br><small>${s.operator}</small></div></div>`); }
        function openWallet(id) { currentClientId=id; const c=customers.find(x=>x.id==id); const db=sales.filter(s=>s.clientId==id && !s.isPaid).reduce((a,b)=>a+(b.total-b.paidAmount),0); document.getElementById('walletName').innerText=c.name; document.getElementById('walletDebt').innerText=`R$ ${db.toFixed(2)}`; const tb=document.getElementById('walletHistoryBody'); tb.innerHTML=''; sales.filter(s=>s.clientId==id && !s.isPaid).forEach(s=>tb.innerHTML+=`<tr><td>${new Date(s.date).toLocaleDateString()}</td><td>R$ ${s.total}</td><td>Dev: ${(s.total-s.paidAmount).toFixed(2)}</td></tr>`); document.getElementById('walletModal').style.display='flex'; }
        function makePayment() { const v=parseFloat(document.getElementById('walletPayInput').value); if(!v)return; const pends=sales.filter(s=>s.clientId==currentClientId && !s.isPaid); let rem=v; pends.forEach(s=>{ const owe=s.total-s.paidAmount; if(rem>0){ if(rem>=owe){s.paidAmount=s.total;s.isPaid=true;rem-=owe;}else{s.paidAmount+=rem;rem=0;} } }); saveData(); openWallet(currentClientId); }
        function printClientStatement() { window.print(); }
        function saveProduct() { const n=document.getElementById('prodName').value; products.push({id:Date.now(),name:n,barcode:document.getElementById('prodBarcode').value,price:parseFloat(document.getElementById('prodPrice').value),qty:parseInt(document.getElementById('prodQty').value)}); saveData(); closeModal('productModal'); renderStock(); }
        function saveCustomer() { customers.push({id:Date.now(),name:document.getElementById('custName').value}); saveData(); closeModal('customerModal'); renderCustomers(); }
        function openProductModal(){document.getElementById('productModal').style.display='flex';} function openCustomerModal(){document.getElementById('customerModal').style.display='flex';} function closeModal(i){document.getElementById(i).style.display='none';} function showToast(m,t){const x=document.createElement('div');x.className='toast';x.innerText=m;document.getElementById('toast-container').appendChild(x);setTimeout(()=>x.remove(),3000);}
        let scanner=null; let starget='';
        function startScanner(t){starget=t;document.getElementById('scanner-modal').style.display='flex';scanner=new Html5QrcodeScanner("reader",{fps:10,qrbox:250});scanner.render(onScanSuccess);}
        function onScanSuccess(d){ stopScanner(); if(starget=='cadastro'){document.getElementById('prodBarcode').value=d;openProductModal();}else{handleBarcodeGeneric(d);} }
        function handleBarcodeGeneric(c){ const p=products.find(x=>x.barcode==c); if(p){addToCart(p.id);showToast('+ '+p.name);}else{showToast('Erro','error');} }
        function stopScanner(){if(scanner)scanner.clear();document.getElementById('scanner-modal').style.display='none';}

        checkLicense();

    </script>
</body>
</html>
